## Telemetry Management

The telemetry must perform the following actions:

-   Get Data from real time PXI.

-   Save data locally for two days. And only two days.

-   Send data to TCS every 50 ms. (this can be configured by topic in the
    configuration file)

The mentioned actions are performed by two different tasks. One for getting the
data and saving it locally, this task is called Telemetry logging task. The
other for sending the received data to the TCS, this task is called
TCP_Telemetry. These two tasks are explained in the next sections.

-   Telemetry logging task: This task is the one obtaining the data from the
    PXI.

-   TCP Telemetry task: This task is responsible of sending all the needed
    telemetry to the CSC over TCP.

This document also contains the documentation of the configuration files for the
telemetry. These files are:

-   Topic Telemetry configuration file: defines all the telemetry to get from
    the PXI classified by topic, default name:
    “TelemetryTopicsConfiguration.ini”.

-   Window Telemetry configuration file: defines the telemetry to display in
    each window, default name: “HMIWindowsTelemetryVariables.ini”.

### Telemetry configuration

#### Topic Telemetry configuration file

For telemetry definition there is a configuration file
“*TelemetryTopicsConfiguration.ini*” in the configuration folder that defines
all the telemetry to get from the real time target classified by topic.

The file has sections according to each topic, so each topic data is configured
in the same place. In each section, there are 7 possible data types available:
BOOL, DBL, DBL Array, Int32, String, String Array and Int64 Array, where DBL
Array and Int64 Array are for high speed signals of DBLs and Int64. Each of the
7 data types correspond to an already coded class in the Telemetry Logging task,
if any other data type is required new code must be added to read and process
that new data type.

The structure used in the “*TelemetryTopicsConfiguration.ini*” file is the one
generated by OpenG Variant Configuration file palette Vis when managing clusters
and arrays. Each data type has as many elements as defined by “\<size(s)\>”, 0
means that this topic has no data of this type. The cluster has 5 fields for
each variable that will be read from the PXI:

-   URL: This field defines the url of the network shared variable to read. This
    is the real identification of the topic since this is unique.

-   Unit: Units of the data. This data will be added to the saved files.

-   Comments: In this field some comments could be added. This data will be
    added to the saved files.

-   TCP_PublishName: here the name that will be used when publishing the data
    over TCP is specified.

-   TCP_Publish: this is a Boolean value, FALSE or TRUE that enables or disables
    the the publication of the variable over TCP.

Boolean and DBL Array data type examples:

>   *Boolean Telemetry Data.\<size(s)\> = "2"*

>   *Boolean Telemetry Data 0.url =
>   "psp://192.168.209.10/SafetyModbusComm/AZlimP"*

>   *Boolean Telemetry Data 0.Unit = ""*

>   *Boolean Telemetry Data 0.Comments = "Azimuth Positive power off limit
>   switch AND topple block pos A"*

>   *Boolean Telemetry Data 0.TCP_PublishName = "aZlimP"*

>   *Boolean Telemetry Data 0.TCP_Publish = "FALSE"*

>   *Boolean Telemetry Data 1.url =
>   "psp://192.168.209.10/SafetyModbusComm/AZlimN"*

>   *Boolean Telemetry Data 1.Unit = ""*

>   *Boolean Telemetry Data 1.Comments = "Azimuth Negative power off limit
>   switch AND topple block pos B"*

>   *Boolean Telemetry Data 1.TCP_PublishName = "aZlimN"*

>   *Boolean Telemetry Data 1.TCP_Publish = "FALSE"*

>   *DBL Array Telemetry Data.\<size(s)\> = "24"*

>   *DBL Array Telemetry Data 0.url = "psp://192.168.209.10/PXIComm_NSV/Azimuth
>   Angle Actual"*

>   *DBL Array Telemetry Data 0.Unit = "deg"*

>   *DBL Array Telemetry Data 0.Comments = "Actual position for azimuth axis"*

>   *DBL Array Telemetry Data 0.TCP_PublishName = "azimuthAngleActual"*

>   *DBL Array Telemetry Data 0.TCP_Publish = "TRUE"*

>   *DBL Array Telemetry Data 1.url = "psp://192.168.209.10/PXIComm_NSV/Azimuth
>   Controller Angle Set"*

>   *DBL Array Telemetry Data 1.Unit = "deg"*

>   *DBL Array Telemetry Data 1.Comments = "Actual setpoint of azimuth axis"*

>   *DBL Array Telemetry Data 1.TCP_PublishName = "azimuthAngleSet"*

>   *DBL Array Telemetry Data 1.TCP_Publish = "TRUE"*

Apart of the variables, each topic also includes the configuration for TCP
publication as a topic. For configuring this there are two values:

-   TopicID: the identifier of the topic, this will be published as part of the
    tCP message to identify the Topic.

-   TopicFrequencyMultiple50ms: this value is used to configure the publication
    frequency of the topic.

#### Window Telemetry configuration file

For window telemetry definition there is a configuration file
“*HMIWindowsTelemetryVariables.ini*” in the configuration folder that defines
the telemetry to display in each window.

The file has sections according to each window, so each window reads this file
to know which variables are needed for the window, this variables are then
searched in the Topic Telemetry configuration file to get the URL that
corresponds to each variable. In each section, there are 7 possible data types
available, the same data types defined in the Topic Telemetry configuration file
(see previous section).

The structure used in the “*HMIWindowsTelemetryVariables.ini*” file is the one
generated by OpenG Variant Configuration file palette Vis when managing arrays.
An example for the Azimuth cAble wrap is as follows:

>   *[Azimuth Cable Wrap]*

>   *String Telemetry Variables.\<size(s)\> = "3"*

>   *String Telemetry Variables 0 = "PXIComm_NSV/ACW Status"*

>   *String Telemetry Variables 1 = "PXIComm_NSV/ACW Status Drive 1"*

>   *String Telemetry Variables 2 = "PXIComm_NSV/ACW Status Drive 2"*

>   *DBL Telemetry Variables.\<size(s)\> = "0"*

>   *DBL Array Telemetry Variables.\<size(s)\> = "7"*

>   *DBL Array Telemetry Variables 0 = "PXIComm_NSV/ACW Angle 1"*

>   *DBL Array Telemetry Variables 1 = "PXIComm_NSV/ACW Angle 2"*

>   *DBL Array Telemetry Variables 2 = "PXIComm_NSV/Azimuth Angle Actual"*

>   *DBL Array Telemetry Variables 3 = "PXIComm_NSV/ACW Speed 1"*

>   *DBL Array Telemetry Variables 4 = "PXIComm_NSV/ACW Speed 2"*

>   *DBL Array Telemetry Variables 5 = "PXIComm_NSV/CCW Current 1"*

>   *DBL Array Telemetry Variables 6 = "PXIComm_NSV/CCW Current 2"*

>   *Boolean Telemetry Variables.\<size(s)\> = "3"*

>   *Boolean Telemetry Variables 0 = "PXIComm_NSV/ACW Positive Direcctional
>   limit Switch"*

>   *Boolean Telemetry Variables 1 = "PXIComm_NSV/ACW Negative Direcctional
>   limit Switch"*

>   *Boolean Telemetry Variables 2 = "SafetyModbusComm/stoAZCW"*

>   *String Array Telemetry Variables.\<size(s)\> = "1"*

>   *String Array Telemetry Variables 0 = "PXIComm_NSV/ACW Interlocks"*

>   *INT32 Telemetry Variables.\<size(s)\> = "0"*

>   *Int64 Array Telemetry Variables.\<size(s)\> = "0"*

#### Telemetry Configuration from Files Initialization

For reading and initializing the telemetry configuration from the previous
mentioned 2 files there is a VI. This VI is explained in this section as it is
assumed to be important.

##### VI description

Read the configuration files for the telemetry and initialize the FGV that will
save the configuration for each execution.

![](media/7befdc9e76a314260fc13051309ae835.png)

Figure 1.
ManageTelemetryConfiguration.lvlib_InitTelemetryConfigurationFromFiles.vi
context help.

##### Block diagram

![](media/1a954192cffd0f4ef5a9ac3e5c9cfeb2.png)

Figure 2.
ManageTelemetryConfiguration.lvlib_InitTelemetryConfigurationFromFiles.vi block
diagram 1.

##### List of subVIs

-   GetTelemetryURLPath.vi: Gets the telemetry logging directory path and
    creates if missing

![](media/932c280570d0c737c2ba57afcddb1822.png)

Figure 3. GetTelemetryURLPath.vi context help.

-   ManageTelemetryConfiguration.lvlib:FGV_TelemetryTopicsDefinitions.vi: FGV
    for window telemetry URLs

![](media/efe2c371d95474c3f8c17acfd8618cc7.png)

Figure 4. ManageTelemetryConfiguration.lvlib:FGV_TelemetryTopicsDefinitions.vi
context help.

-   ManageTelemetryConfiguration.lvlib:FGV_WindowTelemetryURLs.vi: FGV for
    window telemetry URLs

![](media/f87c209deb4287435884eb88f5d21f29.png)

Figure 5. ManageTelemetryConfiguration.lvlib:FGV_WindowTelemetryURLs.vi context
help.

-   ManageTelemetryConfiguration.lvlib:GetURLsForVariables.vi: Here the URL that
    corresponds to each variable type is obtained.

![](media/9889332db525a1aa3e56bdd9864e3a9e.png)

Figure 6. ManageTelemetryConfiguration.lvlib:GetURLsForVariables.vi context
help.

-   ManageTelemetryConfiguration.lvlib:GetURLsFromTopicDefinitions.vi: Get the
    URL from TopicDefinition for the specified VariableNames

![](media/03f751f23223ab9b166701c6f4c7d107.png)

Figure 7. ManageTelemetryConfiguration.lvlib:GetURLsFromTopicDefinitions.vi
context help.

-   ManageTelemetryConfiguration.lvlib:ItemNotFoundError.vi: Here the error is
    set explaining which item was not found while reading the TelemetryTopic
    configuration

![](media/1be25e85fca41c98520182535244076d.png)

Figure 8. ManageTelemetryConfiguration.lvlib:ItemNotFoundError.vi context help.

-   ManageTelemetryConfiguration.lvlib:ReadTelemetryTopicsConfigFile.vi: Read
    topics configuration file and save the read data into a FGV.

![](media/9b516e99237d8fa55da1f540d1738a5d.png)

Figure 9. ManageTelemetryConfiguration.lvlib:ReadTelemetryTopicsConfigFile.vi
context help.

-   ManageTelemetryConfiguration.lvlib:ReadWindowTelemetryURLs.vi: Reads the
    config file containing all the diferent URLs for all the requiered telemetry
    and adds this URLs to a FGV

![](media/60efce2ca841fb47f0e7953a672a7e4e.png)

Figure 10. ManageTelemetryConfiguration.lvlib:ReadWindowTelemetryURLs.vi context
help.

-   NI_LVConfig.lvlib:Close Config Data.vi: Writes data to the
    platform-independent configuration file identified by refnum and then closes
    the reference to that file.

![](media/45706de65e90257748db382f3e31a123.png)

Figure 11. NI_LVConfig.lvlib:Close Config Data.vi context help.

-   NI_LVConfig.lvlib:Get Section Names.vi: Gets the names of all sections from
    the configuration data identified by refnum.

![](media/ac1b2c087a7d2b3c665971b0369dafee.png)

Figure 12. NI_LVConfig.lvlib:Get Section Names.vi context help.

-   NI_LVConfig.lvlib:Open Config Data.vi: Opens a reference to the
    configuration data found in a platform-independent configuration file.

![](media/e1e59827118c4533c7774a5cfc6a4fcc.png)

Figure 13. NI_LVConfig.lvlib:Open Config Data.vi context help.

-   Read Key (Variant)__ogtk.vi: Reads a value associated with key in a
    specified section of the configuration data identified by refnum. If "key"
    input is not specified, the name of the variant object is used as the key.
    the "found?" output will be TRUE for compount objects (clusters) only if all
    elements (recursively) are found. For example a Boolean named "Enable" with
    a value of TRUE would correspond to the key-value pair: Enable=TRUE Note:
    Special characters in section and key names will be escape-coded. These
    include the following: \\00-\\1F (non-printable chars); "[", "]", and "="
    (INI syntax elements); \\FE ("þ") and \\FF ("ÿ") (legacy bracket encoding);
    Additionally, the escape character, "\\", will be escaped as "\\\\".

![](media/ef7f95b8a83143d2eb6da1cc37e37162.png)

Figure 14. Read Key (Variant)__ogtk.vi context help.

Telemetry logging task
----------------------

This task is the one obtaining the data from the PXI. This task does two main
things:

1.  Read the data from the PXI and store it in memory. To be accessible by the
    rest of tasks/windows that may need the data.

2.  Save the read data in TDMS format locally, as said before for 2 days. This
    files after a certain time are zipped (conversion to \*.zip) to reduce space
    in the hard drive.

For doing this the variables are read from the PXI using the URLs defined at the
Topic Telemetry configuration file. Part of this task is also configured using
the “*HMIConfig.xml*” file, as it is considered to be general configuration and
not topic specific configuration. The configuration values obtained from that
file are:

-   File_Saving_directory_path: this is a relative path starting at the project
    location.

-   HMIWindowsTelemetryVariables_file_path: here the absolute path to the Window
    Telemetry configuration file is specified.

-   TelemetryTopics_file_path: here the absolute path to the Topic Telemetry
    configuration file is specified.

-   DataAcquieringLoopFrequency_ms: this value corresponds to the timing of the
    acquisition loop of the telemetry variables in mili seconds.

-   Telemetry_Decimate_Save: this value is used to avoid overloading when
    saving, this value is used to divide the saving into bigger arrays to save
    into the TDMS, the value corresponds to the iteration multiple of the data
    acquisition loop. This means that with a default value of 10 the arrays with
    50 values obtained every 50 ms are saved every (10\*50ms) 500 ms in arrays
    of 500 values size.

-   TelemetryTaskConfig.DataHistoryDays: this value corresponds to the maximum
    value of stored data in days. The default value is 2, this means that files
    older than 2 days will be erased.

-   TelemetryTaskConfig.SecondsToLeaveUnZipped: this value, in seconds,
    corresponds to the minimum time for TDMS files to be unzipped. This means
    that the last TDMS to be zipped will be the actual time minus this value.
    With the default value of 3600, means that there will be unzipped files for
    the last hour.

#### Task process

This task was created using the NI GOOP Developing Suite, this task is object
oriented and the communication between methods is done using queues and user
events. The task main is contained in the process.vi, here there are 6 loops.

-   The loop on top is used for CMD reception.

-   The Data acquiring loop, is the one reading the network shared variables
    from the PXI.

-   The Data saving loop, is the one that writes the acquired data to TDMS.

-   The Check variables connection loop, this loop is used to reconnect the
    variables that may fail when read in the Data acquiring loop.

-   UpdateActualData loop, this loop gets the data from the Data acquiring loop
    and stores it into a DVR to be accessible by other tasks.

-   SendActualDataEvent loop, this event gets the data from the Data acquiring
    loop and publishes an event with the DBL and DBL Array data types. This
    event is used in the windows only, to plot the values into graphs.

![](media/7293ce79e1e4a1065905e07662a6e44b.png)

Figure 15. Telemetry Logging task Process

##### CMD Reception loop

This loop receives the CMDs from the methods and passes the required actions to
the corresponding loop.

###### Init

Here the initialization actions are executed.

![](media/8311c37d8944346ab1740963faa90d5e.png)

Figure 16. TelemetryLogingTask.lvclass_Process.vi Init.

###### Idle

This state is executed constantly after executing every new CMD, here the events
created at the methods are received and executed in the next iteration.

![](media/30bfc3bdc24eac36d8a005f25bfcfce9.png)

Figure 17. TelemetryLogingTask.lvclass_Process.vi Idle.

###### Timeout

This state is executed when there is something that must be executed in the
specified timeout of the Idle state event structure.

![](media/bf718aee9ca894c6d1f75669252159c0.png)

Figure 18. TelemetryLogingTask.lvclass_Process.vi Timeout from Idle case.

![](media/e7d944f4767feb45d0aad87d5ef6afdb.png)

Figure 19. TelemetryLogingTask.lvclass_Process.vi Timeout.

###### CMD-ShowWindow

This state is used to show the front panel of the process.

![](media/0ad63204c3947d40e72ec4484c372f55.png)

Figure 20. Loop states: CMD-ShowWindow

###### CMD-HideWindow

This state is used to hide the front panel of the process.

![](media/7c0492c6c1e98121de21d12fb8c94a15.png)

Figure 21. Loop states: CMD-HideWindow

###### CMD-AddVariable

Verify if the variable exists, if not the variable is connected and added other
ways not.

![](media/96f34d720e2ab198301ac52f9de37f39.png)

Figure 22. TelemetryLogingTask.lvclass_Process.vi CMD-AddVariable.

###### CMD-AddVariableHHD

Verify if the variable exists, if not the variable is connected but NOT ADDED,
this would be made by another method that will add only the variables needed for
the loaded window.

![](media/0675042b5005091b18d50cdf6e43b3a8.png)

Figure 23. TelemetryLogingTask.lvclass_Process.vi CMD-AddVariableHHD.

###### CMD-MonitorVariablesHHD

Verify if the variable exists, if not the variable is added other ways not. If
monitor is true, the variable is added for monitoring if false its removed from
monitoring.

![](media/8424653992a843cf12dd11c04b66713e.png)

Figure 24. TelemetryLogingTask.lvclass_Process.vi 3.2.1.1.8
CMD-MonitorVariablesHHD.

###### CMD-Adquisition

Manage the variables acquisition, start or stop it.

![](media/b28672a598875ebbe1650a921544bd4a.png)

Figure 25. TelemetryLogingTask.lvclass_Process.vi CMD-Adquisition.

###### CMD-ChangeSaveFilePath

Change the path for saving the telemetry, send the new path to the Data Saving
Loop.

![](media/9c2020392132ea2f8398b87997cc7f45.png)

Figure 26. TelemetryLogingTask.lvclass_Process.vi CMD-ChangeSaveFilePath.

###### CMD-SaveData

Manage the data saving, start or stop it.

![](media/39b15447144c594574394b2fd21d98d2.png)

Figure 27. TelemetryLogingTask.lvclass_Process.vi CMD-SaveData.

###### CMD-Error

Get the error and set it to the error line, this will make the task to go to the
Error case and process it there.

![](media/62b194306cbe46243a7474ffd683cd3c.png)

Figure 28. TelemetryLogingTask.lvclass_Process.vi CMD-Error.

###### Error

Send the error from the error line to the Error Task.

![](media/6785cc72b418dad3d25e4ae274e5ee94.png)

Figure 29. TelemetryLogingTask.lvclass_Process.vi Error.

###### CMD-Shutdown

Here the actions to shutdown the task are executed.

![](media/26eadf8e759401cd24c2c7b5f59aed90.png)

Figure 30. TelemetryLogingTask.lvclass_Process.vi CMD-Shutdown.

##### Data Acquiring Loop

The Data acquiring loop, is the one reading the network shared variables from
the PXI. This loop then sends the data to the other loops to manage it as
intended in each case.

![](media/740e407d42cb98219f98ec3b3bf912d9.png)

Figure 31. Data Acquiring loop

##### Data Saving Loop

The Data saving loop, is the one that writes the acquired data to TDMS.

![](media/bca3b2d13dea126c1c7a08e65b886447.png)

Figure 32. Data Saving Loop

##### Check Variables Connection Loop

The Check variables connection loop, this loop is used to reconnect the
variables that may fail when read in the Data acquiring loop.

![](media/38506fa5d1e4b69bfb42127ae0c034a1.png)

Figure 33. Check Variables Connection Loop

##### Update Actual Data Loop

Update Actual Data loop, this loop gets the data from the Data acquiring loop
and stores it into a DVR to be accessible by other tasks.

![](media/5850dea623cf2e23c01cf8b02e1135e0.png)

Figure 34. Update Actual Data loop

##### Send Actual Data Event loop

Send Actual Data Event loop, this event gets the data from the Data acquiring
loop and publishes an event with the DBL and DBLarray data types. This event is
used in the windows only, to plot the values into graphs.

![](media/072e7885289d9cdf9b59e1ca09da795b.png)

Figure 35. Send Actual Data Event loop

#### Task methods

Here the available methods for this task are explained.

##### AddVariableMethodChoice

This method selects which add variable method must be used depending on the
current device Global variable (EUI or HHD).

![](media/53be36f00dc8796f1c8f39eac263ce0a.png)

Figure 36. TelemetryLogingTask.lvclass_AddVariableMethodChoice.vi context help.

##### AssignInitClasses

Here the telemetry variable objects are initialized using the
TelemetryTopicDefinitions.

![](media/9f8244908aae0722aa7189e48e01411c.png)

Figure 37. TelemetryLogingTask.lvclass_AssignInitClasses.vi context help.

##### ChangeFileSavingPath

Change the file path to save the telemetry data

![](media/f0a19ed5efd534092c4cf72ee77df262.png)

Figure 38. TelemetryLogingTask.lvclass_ChangeFileSavingPath.vi context help.

##### CleanUp

execute the clean up actions for the task

\- Stop the process.vi

\- Release queues

\- Destroy user events

\- Delete DVRs

![](media/59d21d74e8eb543d6ada5126d42eac44.png)

Figure 39. TelemetryLogingTask.lvclass_CleanUp.vi context help.

##### GetAllTelemetry

Returns the data from the actualDataDVR

![](media/f87d89733b4735a12ba8402da31d3385.png)

Figure 40. TelemetryLogingTask.lvclass_GetAllTelemetryData.vi context help.

##### GetTelemetryDataURL

Returns the data from the queue

![](media/8677c0910f62436c759c00f690dc31b7.png)

Figure 41. TelemetryLogingTask.lvclass_GetTelemetryDataURL.vi context help.

##### ManageAdquisition

Manages the adquisition of the telemetry task

![](media/5c56b96c5e6c7b4f0a6976dbae0e6983.png)

Figure 42. TelemetryLogingTask.lvclass_ManageAdquisition.vi context help.

##### ManageSaveData

Turns on or off the telemetry data saving to file (tdms).

![](media/34e43cdc74247e08a48a2f92165ace62.png)

Figure 43. TelemetryLogingTask.lvclass_ManageSaveData.vi context help.

##### MonitorVariablesHHD

Adds a variable to the telemetry task for the HHD system

![](media/b95840eb2a61e258a9b2e0cb5efb1cb1.png)

Figure 44. TelemetryLogingTask.lvclass_MonitorVariablesHHD.vi context help.

##### Read TelemetryEvent

Gets the TelemetryEvent reference from the class object

![](media/66df1ee3843d6e7484785398e7f43a8c.png)

Figure 45. TelemetryLogingTask.lvclass_Read TelemetryEvent.vi context help.

##### TelemetryFilePathCreation

Generates the path to save the telemetry data for each 10 minutes

![](media/ecd57eb2f56ddaff20b6ab61bc26755f.png)

Figure 46. TelemetryLogingTask.lvclass_TelemetryFilePathCreation.vi context
help.

##### TelemetryLogingTask_Init

Initialize the telemetry process. Also includes the compression of old telemetry
files (TDMS) onto zip files.

![](media/d887f610e8f5256f3439d49b30370af3.png)

Figure 47. TelemetryLogingTask.lvclass_TelemetryLogingTask_Init.vi context help.

TCP Telemetry task
------------------

This task is responsible of sending all the needed telemetry to the CSC over
TCP.

#### Task process

This task was created using the NI GOOP Developing Suite, this task is object
oriented and the communication between methods is done using queues and user
events. The task main is contained in the process.vi, here there are two loops.
The loop on top is used for CMD reception and the bottom one for publishing.
This process has only one instance that manages all the telemetry data.

![](media/57911673c165a91823df05097d5c7442.png)

Figure 48. TCP Telemetry task

##### CMD Reception loop

This loop receives the CMDs from the methods and passes the required actions to
the publishing loop.

###### Init

Here the initialization actions are executed.

![](media/34c5e7d190b5f2b833b64116c31a6ad0.png)

Figure 49. Loop states: Init

###### Idle

This state is executed constantly after executing every new CMD, here the events
created at the methods are received and executed in the next iteration.

![](media/40f48445aaeade20137616f190917a6b.png)

Figure 50. Loop states: Idle

###### Timeout

This state is executed when there is something that must be executed in the
specified timeout of the Idle state event structure, see Figure 51.

![](media/f7565b74148bf04cd1f4f1fb69d642c1.png)

Figure 51. Timeout state from Idle state

![](media/1c6be57a00e3acfe2cfb544b4d0c8a35.png)

Figure 52. Loop states: Timeout

###### CMD-ShowWindow

This state is used to show the front panel of the process.

![](media/2fc66861285c454098d66de610dc1d43.png)

Figure 53. Loop states: CMD-ShowWindow

###### CMD-HideWindow

This state is used to hide the front panel of the process.

![](media/b2c602d1f37e364f2519be97641fca53.png)

Figure 54. Loop states: CMD-HideWindow

###### CMD-StartPublish

This state is executed when the StartPublish method is used. Here the TCP
publishing loop is started.

![](media/07eecdfe1b0bf76d578e653d2dc99cb0.png)

Figure 55. Loop states: StartPublish

###### CMD-StopPublish

This state is executed when the StopPublish method is used. Here the TCP
publishing loop is stopped.

![](media/7af6afa7a6f49eb99ab7e6dd1209a961.png)

Figure 56. Loop states: CMD-StopPublish

###### SendError

This state is executed when the SendError CMD is received, this CMD is sent by
the TCP publishing loop at the error handling state. Here the received error is
set to the error line to enter the error case in the next iteration.

![](media/2b4ce927215df8a95583195975f4b0f8.png)

Figure 57. Loop states: CMD-SendError

###### Error

This state is reached when an error occurred at the loop or is received from the
publishing loop. Here the error is posted to the error task.

![](media/222a40c7a37a1bd9230765494fd30140.png)

Figure 58. Loop states: Error

###### CMD-Shutdown

This state is reached when the shutdown CMD is received. This loop is used to
stop the TCP publishing loop.

![](media/ae4724af78adecc36068d2740940da76.png)

Figure 59. Loop states: CMD-Shutdown

#####  TCP Publishing loop

This loop is responsible of publishing the telemetry over TCP. This loop
contains a very simple state machine with 5 states, each of them is explained in
the upcoming sections.

![](media/d5b66fb6e3281d51754fc31ae2d32615.png)

Figure 60. Publishing loop

###### Init

This state is launched at start. Here the DVR with the loop data is initialized
to default values. The next state is launched: Wait.

![](media/3a56ace2e388ce99cae68b6dea2e23a2.png)

Figure 61. Loop states: Init

###### Wait

Here the data for the loop is read from the DVR.

-   If Publish?=True the next state is launched: Read&PublishData

-   If Publish?=False the next state is launched: Wait

![](media/1421f7884dabfe8d9030bb9180114d1c.png)

Figure 62. Loop states: Wait

###### Read&PublishData

Here the data for the loop is read from the DVR and the main task of this loop
is done: read telemetry and publish it over TCP.

-   If Publish?=True the next state is launched: Read&PublishData

-   If Publish?=False the next state is launched: Wait

![](media/df83acb1801c5dbd2132c53d86849c98.png)

Figure 63. Loop states: Read&PublishData

###### ErrorHandling

The state machine guard launches this state if there is an error at the error
line from the previous state. Here the error is posted to the CMD reception
loop.

![](media/87c460727b18724299503ccd26c36aff.png)

Figure 64. Loop states: ErrorHandling

###### Exit

This state is launched from the guard and launches when the loop data DVR exit
is set to true. Here the loop is stopped.

![](media/e3439cbac99d63a060c2872de48c6603.png)

Figure 65. Loop states: Exit

#### Task methods

Here the available methods for this task are explained.

##### TCP_Telemetry_Init 

This VI is used to launch the process, to do so some inputs are required:

-   Telemetry Task Reference: here the reference to the telemetry task is given
    to be able of reading the telemetry from inside the task.

-   Telemetry URL config file path in: Topic Telemetry configuration file.

-   HMIconfig XML File Path in: here the general configuration file
    “*HMIConfig.xml*” must be given.

![](media/faa4e9a776a49e7524458218e575eb42.png)

Figure 66. Task method: TCP_Telemetry_Init

##### CleanUp

This VI is used to stop the task and release all the references generated for
this task.

![](media/e390bc701734422389895c0d5884c582.png)

Figure 67. Task method: CleanUp

##### ControlProcessWindow

This VI is used to show or hide the process front panel. Depending on the
ShowProcessWindow control value.

![](media/42d6a3e3c5bc8c2b4adb6aa2d8bc87d7.png)

Figure 68. Task method: ControlProcessWindow

##### StartPublish 

This VI is used to start publishing data over TCP.

![](media/cc4a2c2fa63eb088ad2a7e9c8a6d6123.png)

Figure 69. Task method: StartPublish

##### StopPublish 

This VI is used to start publishing data over TCP.

![](media/f9c0e562997f5a97f2c1362d44cf9d86.png)

Figure 70. Task method: StopPublish

##### CheckObjectInitialized

This VI is used to check if the object was initialized or not.

![](media/518e51182596fd253a1819ac49ceb70e.png)

Figure 71. Task method: CheckObjectInitialized

Testing
-------

There is a project created to test that both tasks work properly. This project
is located inside the “*HMIComputers*” repository inside the TCP_Telemetry
folder, relative path:
“*HMIComputers\\TCP_Telemetry\\TestTCP_Task\\TestTCP_Task\\TestTCP_Task.lvproj*”.

**Note**: To run this test the “*jki_labs_tool_vi_tester*” package must be
installed, it can be found in the VI package manager or here:
<https://www.vipm.io/package/jki_labs_tool_vi_tester/>

![](media/c890b7591bc2731374626ffcf443665b.png)

Figure 72. TestTCP_Task project view

To execute the test, follow these steps:

1.  Go to “*Tools \>\> VI Tester \>\> Test Vis…*” (see Figure 73).

![](media/82e7710b0a2bfe47ecc3d9133390240e.png)

>   Figure 73. Open the VI Tester

1.  After opening the VI Tester the window should look like Figure 74.

![](media/8bb99b74ac6211d5f5566e390b3f9cdf.png)

Figure 74. VI Tester after opening

1.  Run the test, click on the green play button, see Figure 75.

![](media/51ed8c8cb3aaade4e0dfff636a7142e9.png)

Figure 75. Run test from VI Tester

1.  Check test results, the result must be passed as shown in Figure 76.

![](media/7342723fa19ba888fc82330a69980371.png)

Figure 76. Test results.

1.  Close the VI Tester and the TestTCP_Task.lvproj.
